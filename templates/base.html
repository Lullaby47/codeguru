<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}CodeGuru{% endblock %}</title>
    <link rel="stylesheet" href="/static/styles.css">

    {# Get base URL for Open Graph - prefer PUBLIC_BASE_URL (Railway public domain) over request.base_url (internal) #}
    {% if public_base_url %}
        {% set og_base_url = public_base_url %}
        {% set og_full_url = public_base_url ~ request.url.path %}
        {% set og_image_url = public_base_url ~ '/static/share.png' %}
    {% else %}
        {% set og_base_url = request.base_url %}
        {% set og_full_url = request.url %}
        {% set og_image_url = request.base_url ~ 'static/share.png' %}
    {% endif %}

    {# Open Graph / Facebook #}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_full_url }}">
    <meta property="og:title" content="CodeGuru â€” Secure Portal">
    <meta property="og:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta property="og:image" content="{{ og_image_url }}">

    {# Twitter #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ og_full_url }}">
    <meta name="twitter:title" content="CodeGuru â€” Secure Portal">
    <meta name="twitter:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta name="twitter:image" content="{{ og_image_url }}">

    {# Additional SEO #}
    <meta name="description" content="Official CodeGuru login and dashboard. Secure access to your account.">
</head>

<body>

{% set hide_nav = request.url.path in ['/login', '/signup'] %}

{% if not hide_nav %}
<div class="nav">

    <div class="nav-left">
        <!-- User Profile Icon -->
        <div class="user-profile-icon" id="userProfileIcon" title="Your Profile" 
             data-username="{% if user %}{{ user.username }}{% else %}Guest{% endif %}"
             data-email="{% if user %}{{ user.email }}{% else %}guest@example.com{% endif %}"
             data-streak="{% if user %}{{ user.streak }}{% else %}0{% endif %}"
             data-verified="{% if user %}{{ 'Yes' if user.is_verified else 'No' }}{% else %}No{% endif %}">
            <div class="profile-level">{% if user %}{{ user.username }}{% else %}Guest{% endif %}</div>
        </div>

        <!-- Dashboard -->
        <a href="/dashboard" title="Dashboard">
            <div class="nav-item dashboard-icon">
                <span>â–®</span><span>â–®</span><span>â–®</span>
            </div>
        </a>
    </div>

    <div class="nav-quote" id="navQuote">
        Small progress is still progress.
    </div>

    <a href="/dashboard">
        <div class="nav-center">CODEGURU</div>
    </a>

    <div class="nav-right">
        <!-- Admin Links -->
        {% if user %}
            {% set is_main_admin = user.id == 1 %}
            {% set is_co_admin = user.role == "coadmin" %}
            {% set is_admin = is_main_admin or is_co_admin %}
            
            {% if is_admin %}
            <!-- Create Challenge (all admins) -->
            <a href="/admin/challenge/new" title="Create Challenge">
                <div class="nav-item" style="color: #00ff66; font-size: 18px;">âž•</div>
            </a>
            
            <!-- Promote User (main admin only) -->
            {% if is_main_admin %}
            <a href="/admin/users" title="Promote User">
                <div class="nav-item" style="color: #ffc800; font-size: 18px;">ðŸ‘¤</div>
            </a>
            {% endif %}
            {% endif %}
        {% endif %}

        <!-- Today's Challenge -->
        <a href="/challenge" title="Today's Challenge">
            <div class="nav-item challenge-icon">âŒ¬âŒ¬</div>
        </a>

        <!-- Journey -->
        <a href="/journey" title="Journey">
            <div class="nav-item journey-icon">
                â”ƒ<span>â”Šâ”Šâ”Š</span>â”ƒ
            </div>
        </a>

        <!-- Logout -->
        <a href="/logout" title="Logout" class="logout-link" id="logoutLink">
            <div class="nav-item logout-icon">
                <span class="logout-symbol"></span>
            </div>
        </a>
    </div>

</div>
{% endif %}
{% if not hide_nav %}
<!-- Row 2: CODEGURU title below nav on mobile -->
<div class="nav-title-mobile">
    <a href="/dashboard">
        <div class="codeguru-title-mobile">CODEGURU</div>
    </a>
</div>
{% endif %}

<div class="page {% if not hide_nav %}with-nav{% endif %}">
    {% block content %}{% endblock %}
</div>

<script>
    const quotes = [
        "Small progress is still progress.",
        "You are not behind. You are building.",
        "Consistency beats motivation.",
        "Every expert was once confused.",
        "This is hard because it matters.",
        "Stay. Learn. Repeat.",
        "The bug is part of the lesson.",
        "One commit closer than yesterday."
    ];

    let qIndex = Math.floor(Math.random() * quotes.length);
    const quoteEl = document.getElementById("navQuote");

    function setQuote() {
        if (quoteEl) quoteEl.textContent = quotes[qIndex];
    }

    function nextQuote() {
        qIndex = (qIndex + 1) % quotes.length;
        setQuote();
    }

    setQuote();
    setInterval(nextQuote, 300000);
    if (quoteEl) quoteEl.addEventListener("click", nextQuote);

    // User Profile Icon Click Handler (desktop)
    const profileIcon = document.getElementById("userProfileIcon");
    if (profileIcon) {
        profileIcon.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // User Profile Icon Click Handler (mobile)
    const profileIconMobile = document.getElementById("userProfileIconMobile");
    if (profileIconMobile) {
        profileIconMobile.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // Show Profile Modal (fetches category levels from /api/me/progress)
    function showProfileModal() {
        const profileIcon = document.getElementById("userProfileIcon") || document.getElementById("userProfileIconMobile");
        if (!profileIcon) return;

        const username = profileIcon.getAttribute("data-username") || "Guest";
        const streak = profileIcon.getAttribute("data-streak") || "0";
        const verified = profileIcon.getAttribute("data-verified") || "No";

        const overlay = document.createElement("div");
        overlay.className = "profile-overlay";
        overlay.setAttribute("aria-hidden", "false");
        overlay.innerHTML = `
            <div class="profile-modal" onclick="event.stopPropagation()">
                <h2>${username}</h2>
                <div class="profile-stats">
                    <div class="profile-stat profile-stat-levels">
                        <div class="profile-stat-label">Category Levels</div>
                        <div class="profile-levels-container">
                            <div class="profile-levels-loading">Loading...</div>
                        </div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Streak</div>
                        <div class="profile-stat-value">${streak}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Verified</div>
                        <div class="profile-stat-value" style="font-size: 20px; margin-top: 10px;">${verified === 'Yes' ? 'âœ“' : 'âœ—'}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Status</div>
                        <div class="profile-stat-value" style="font-size: 18px; margin-top: 10px;">Active</div>
                    </div>
                </div>
                <div class="profile-hint">Click anywhere to close</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Fetch category levels
        fetch("/api/me/progress", { credentials: "same-origin" })
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
                const container = overlay.querySelector(".profile-levels-container");
                if (!container) return;
                const levels = data.category_levels || [];
                if (levels.length === 0) {
                    container.innerHTML = '<div class="profile-level-empty">No categories yet</div>';
                } else {
                    container.innerHTML = levels.map(item => 
                        `<div class="profile-level-item">${item.main_category}: ${item.level}</div>`
                    ).join("");
                }
            })
            .catch(() => {
                const container = overlay.querySelector(".profile-levels-container");
                if (container) container.innerHTML = '<div class="profile-level-empty">Unable to load</div>';
            });
        
        overlay.addEventListener("click", function() {
            overlay.style.animation = "fadeOut 0.3s ease";
            overlay.setAttribute("aria-hidden", "true");
            setTimeout(() => overlay.remove(), 300);
        });
    }

    // Check for level up from URL parameter or session storage
    function showCongratulations(newLevel, oldLevel) {
        const overlay = document.createElement("div");
        overlay.className = "congrats-overlay";
        overlay.innerHTML = `
            <div class="congrats-modal" onclick="event.stopPropagation()">
                <h1>ðŸŽ‰ Congratulations!</h1>
                <p>You've been promoted!</p>
                <div class="congrats-level">Level ${oldLevel} â†’ ${newLevel}</div>
                <p>Keep up the great work!</p>
                <div class="congrats-hint">Click anywhere to continue</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Dismiss on click anywhere
        overlay.addEventListener("click", function() {
            overlay.style.animation = "fadeOut 0.3s ease";
            setTimeout(() => overlay.remove(), 300);
            // Remove from session storage
            sessionStorage.removeItem("levelUp");
        });
    }

    // Check URL parameters for level up
    const urlParams = new URLSearchParams(window.location.search);
    const levelUp = urlParams.get("level_up") === "true";
    const newLevel = urlParams.get("new_level");
    const oldLevel = urlParams.get("old_level");
    
    if (levelUp && newLevel && oldLevel) {
        showCongratulations(parseInt(newLevel), parseInt(oldLevel));
        // Clean URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }

    // Logout now uses server-rendered confirmation page (/logout)
    // No JavaScript modal needed - works on all browsers including Samsung Internet
</script>

<!-- Logout confirmation is now server-rendered at /logout route -->

</body>
</html>
