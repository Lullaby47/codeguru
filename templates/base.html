<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}CodeGuru{% endblock %}</title>
    
    {# Apply saved theme IMMEDIATELY before any rendering #}
    <script>
    (() => {
        try {
            const saved = localStorage.getItem("codeguru_theme") || "dark";
            document.documentElement.dataset.theme = saved;
            document.addEventListener("DOMContentLoaded", () => {
                document.body.dataset.theme = saved;
            });
        } catch (e) {
            console.error("[THEME] Failed to load saved theme:", e);
        }
    })();
    </script>
    
    <link rel="stylesheet" href="/static/styles.css">

    {# Get base URL for Open Graph - prefer PUBLIC_BASE_URL (Railway public domain) over request.base_url (internal) #}
    {% if public_base_url %}
        {% set og_base_url = public_base_url %}
        {% set og_full_url = public_base_url ~ request.url.path %}
        {% set og_image_url = public_base_url ~ '/static/share.png' %}
    {% else %}
        {% set og_base_url = request.base_url %}
        {% set og_full_url = request.url %}
        {% set og_image_url = request.base_url ~ 'static/share.png' %}
    {% endif %}

    {# Open Graph / Facebook #}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_full_url }}">
    <meta property="og:title" content="CodeGuru ‚Äî Secure Portal">
    <meta property="og:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta property="og:image" content="{{ og_image_url }}">

    {# Twitter #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ og_full_url }}">
    <meta name="twitter:title" content="CodeGuru ‚Äî Secure Portal">
    <meta name="twitter:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta name="twitter:image" content="{{ og_image_url }}">

    {# Additional SEO #}
    <meta name="description" content="Official CodeGuru login and dashboard. Secure access to your account.">
</head>

<body>

{% set hide_nav = request.url.path in ['/login', '/signup'] %}

{% if not hide_nav %}
<div class="nav">

    <div class="nav-left">
        <!-- User Profile Icon -->
        <div class="user-profile-icon" id="userProfileIcon" title="Your Profile" 
             data-username="{% if user %}{{ user.username }}{% else %}Guest{% endif %}"
             data-email="{% if user %}{{ user.email }}{% else %}guest@example.com{% endif %}"
             data-streak="{% if user %}{{ user.streak }}{% else %}0{% endif %}"
             data-verified="{% if user %}{{ 'Yes' if user.is_verified else 'No' }}{% else %}No{% endif %}">
            <div class="profile-level">{% if user %}{{ user.username }}{% else %}Guest{% endif %}</div>
        </div>

        <!-- Dashboard -->
        <a href="/dashboard" title="Dashboard">
            <div class="nav-item dashboard-icon">
                <span>‚ñÆ</span><span>‚ñÆ</span><span>‚ñÆ</span>
            </div>
        </a>
    </div>

    <div class="nav-quote" id="navQuote">
        Small progress is still progress.
    </div>

    <a href="/dashboard">
        <div class="nav-center">CODEGURU</div>
    </a>

    <div class="nav-right">
        <!-- Admin Links -->
        {% if user %}
            {% set is_main_admin = user.id == 1 %}
            {% set is_co_admin = user.role == "coadmin" %}
            {% set is_admin = is_main_admin or is_co_admin %}
            
            {% if is_admin %}
            <!-- Create Challenge (all admins) -->
            <a href="/admin/challenge/new" title="Create Challenge">
                <div class="nav-item" style="color: #00ff66; font-size: 18px;">‚ûï</div>
            </a>
            
            <!-- Promote User (main admin only) -->
            {% if is_main_admin %}
            <a href="/admin/users" title="Promote User">
                <div class="nav-item" style="color: #ffc800; font-size: 18px;">üë§</div>
            </a>
            {% endif %}
            {% endif %}
        {% endif %}

        <!-- Today's Challenge -->
        <a href="/challenge" title="Today's Challenge">
            <div class="nav-item challenge-icon">‚å¨‚å¨</div>
        </a>

        <!-- Journey -->
        <a href="/journey" title="Journey">
            <div class="nav-item journey-icon">
                ‚îÉ<span>‚îä‚îä‚îä</span>‚îÉ
            </div>
        </a>

        <!-- Logout -->
        <a href="/logout" title="Logout" class="logout-link" id="logoutLink">
            <div class="nav-item logout-icon">
                <span class="logout-symbol"></span>
            </div>
        </a>
    </div>

</div>
{% endif %}
{% if not hide_nav %}
<!-- Row 2: CODEGURU title below nav on mobile -->
<div class="nav-title-mobile">
    <a href="/dashboard">
        <div class="codeguru-title-mobile">CODEGURU</div>
    </a>
</div>
{% endif %}

<div class="page {% if not hide_nav %}with-nav{% endif %}">
    {% block content %}{% endblock %}
</div>

<script>
    // ========================================
    // THEME SYSTEM - Global functions with IIFE initialization
    // ========================================
    window.applyTheme = function(theme) {
        try {
            const t = (theme === "light") ? "light" : "dark";
            document.documentElement.dataset.theme = t;
            document.body.dataset.theme = t;
            localStorage.setItem("codeguru_theme", t);
            window.updateThemeButtons(t);
            console.log("[THEME] applied:", t);
        } catch (e) {
            console.warn("[THEME] apply failed", e);
        }
    };

    window.updateThemeButtons = function(theme) {
        document.querySelectorAll(".theme-btn").forEach((b) => {
            const isActive = (b.dataset.theme === theme);
            b.classList.toggle("active", isActive);
            b.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
    };

    // Initialize theme system
    (function() {
        // Apply saved theme ASAP on load
        try {
            const saved = localStorage.getItem("codeguru_theme") || "dark";
            document.documentElement.dataset.theme = saved;
            document.addEventListener("DOMContentLoaded", () => {
                document.body.dataset.theme = saved;
                window.updateThemeButtons(saved);
            });
        } catch (e) {
            console.error("[THEME] load failed:", e);
        }

        // CRITICAL: Use CAPTURE phase (third param = true) to intercept BEFORE modal's stopPropagation
        document.addEventListener("click", (e) => {
            const btn = e.target.closest(".theme-btn");
            if (!btn) return;
            
            const theme = btn.dataset.theme;
            if (!theme) return;
            
            // Stop modal close handler from stealing this click
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log("[THEME] button clicked:", theme);
            window.applyTheme(theme);
        }, true); // <-- CAPTURE PHASE = true

        console.log("[THEME] system initialized");
    })();

    const quotes = [
        "Small progress is still progress.",
        "You are not behind. You are building.",
        "Consistency beats motivation.",
        "Every expert was once confused.",
        "This is hard because it matters.",
        "Stay. Learn. Repeat.",
        "The bug is part of the lesson.",
        "One commit closer than yesterday."
    ];

    let qIndex = Math.floor(Math.random() * quotes.length);
    const quoteEl = document.getElementById("navQuote");

    function setQuote() {
        if (quoteEl) quoteEl.textContent = quotes[qIndex];
    }

    function nextQuote() {
        qIndex = (qIndex + 1) % quotes.length;
        setQuote();
    }

    setQuote();
    setInterval(nextQuote, 300000);
    if (quoteEl) quoteEl.addEventListener("click", nextQuote);

    // User Profile Icon Click Handler (desktop)
    const profileIcon = document.getElementById("userProfileIcon");
    if (profileIcon) {
        profileIcon.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // User Profile Icon Click Handler (mobile)
    const profileIconMobile = document.getElementById("userProfileIconMobile");
    if (profileIconMobile) {
        profileIconMobile.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // Show Profile Modal (fetches category levels from /api/me/progress)
    function showProfileModal() {
        const profileIcon = document.getElementById("userProfileIcon") || document.getElementById("userProfileIconMobile");
        if (!profileIcon) return;

        const username = profileIcon.getAttribute("data-username") || "Guest";
        const streak = profileIcon.getAttribute("data-streak") || "0";
        const verified = profileIcon.getAttribute("data-verified") || "No";

        const overlay = document.createElement("div");
        overlay.className = "profile-overlay";
        overlay.setAttribute("aria-hidden", "false");
        overlay.innerHTML = `
            <div class="profile-modal" onclick="event.stopPropagation()">
                <h2>${username}</h2>
                <div class="profile-row">
                    <div class="profile-row-label">Theme</div>
                    <div class="theme-toggle" role="group">
                        <button type="button" class="theme-btn" data-theme="dark">üåô Dark</button>
                        <button type="button" class="theme-btn" data-theme="light">‚òÄÔ∏è Light</button>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat profile-stat-levels">
                        <div class="profile-stat-label">Category Levels</div>
                        <div class="profile-levels-container">
                            <div class="profile-levels-loading">Loading...</div>
                        </div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Streak</div>
                        <div class="profile-stat-value">${streak}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Verified</div>
                        <div class="profile-stat-value" style="font-size: 20px; margin-top: 10px;">${verified === 'Yes' ? '‚úì' : '‚úó'}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Status</div>
                        <div class="profile-stat-value" style="font-size: 18px; margin-top: 10px;">Active</div>
                    </div>
                </div>
                <div class="profile-stat profile-stat-achievements" style="margin-top: 12px;">
                    <div class="profile-stat-label">Achievements</div>
                    <div class="profile-achievements-container" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">
                        <div class="profile-levels-loading">Loading...</div>
                    </div>
                </div>
                <div class="profile-hint">Click anywhere to close</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Set active theme button based on current theme
        const currentTheme = document.documentElement.dataset.theme || document.body.dataset.theme || "dark";
        window.updateThemeButtons(currentTheme);
        
        // Fetch category levels
        fetch("/api/me/progress", { credentials: "same-origin" })
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
                const container = overlay.querySelector(".profile-levels-container");
                if (!container) return;
                const levels = data.category_levels || [];
                if (levels.length === 0) {
                    container.innerHTML = '<div class="profile-level-empty">No categories yet</div>';
                } else {
                    container.innerHTML = levels.map(item => {
                        const pct = item.required > 0 ? Math.round((item.solved / item.required) * 100) : 0;
                        const ftBadge = item.fast_track ? '<span style="color:#ffd84d;font-size:11px;" title="Fast Track">üöÄ FT</span>' : '<span style="color:#888;font-size:11px;" title="Daily Mode">üìÖ</span>';
                        const toggleBtn = item.fast_track 
                            ? `<button onclick="toggleFastTrack('${item.main_category}', false)" style="padding:4px 10px;font-size:10px;background:rgba(255,100,100,0.2);color:#ff6666;border:1px solid rgba(255,100,100,0.4);border-radius:4px;cursor:pointer;margin-top:4px;">üõë Disable Fast Track</button>`
                            : `<button onclick="toggleFastTrack('${item.main_category}', true)" style="padding:4px 10px;font-size:10px;background:rgba(255,216,77,0.2);color:#ffd84d;border:1px solid rgba(255,216,77,0.4);border-radius:4px;cursor:pointer;margin-top:4px;">üöÄ Enable Fast Track</button>`;
                        return `<div class="profile-level-item" style="margin-bottom:12px;background:#0f0f0f;border:1px solid #1f1f1f;border-radius:6px;padding:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <span class="profile-level-category">${item.main_category}</span>
                                <span class="profile-level-value">${ftBadge} Level ${item.level}</span>
                            </div>
                            <div style="background:#1a1a1a;border-radius:4px;height:5px;margin-top:4px;overflow:hidden;">
                                <div style="height:100%;width:${pct}%;background:#00ff66;border-radius:4px;"></div>
                            </div>
                            <div style="font-size:10px;color:#666;margin-top:2px;">${item.solved}/${item.required} to next level</div>
                            ${toggleBtn}
                        </div>`;
                    }).join("");
                }

                // F8: Render achievements
                var achContainer = overlay.querySelector(".profile-achievements-container");
                if (achContainer && data.achievements) {
                    var achs = data.achievements;
                    if (achs.length === 0) {
                        achContainer.innerHTML = '<div style="color:#666;font-size:12px;">No achievements yet</div>';
                    } else {
                        achContainer.innerHTML = achs.map(function(a) {
                            var opacity = a.earned ? '1' : '0.3';
                            var bdr = a.earned ? '#00ff66' : '#333';
                            return '<div style="opacity:' + opacity + ';background:#0f0f0f;border:1px solid ' + bdr + ';border-radius:8px;padding:8px 10px;text-align:center;min-width:70px;" title="' + a.desc + '">'
                                + '<div style="font-size:20px;">' + a.icon + '</div>'
                                + '<div style="font-size:10px;color:#ccc;margin-top:2px;">' + a.label + '</div>'
                                + '</div>';
                        }).join("");
                    }
                }
            })
            .catch(function() {
                var container = overlay.querySelector(".profile-levels-container");
                if (container) container.innerHTML = '<div class="profile-level-empty">Unable to load</div>';
            });
        
        overlay.addEventListener("click", function() {
            overlay.style.animation = "fadeOut 0.3s ease";
            overlay.setAttribute("aria-hidden", "true");
            setTimeout(() => overlay.remove(), 300);
        });
    }

    // Level-up toast (F4) ‚Äî non-intrusive banner
    function showLevelUpToast(newLevel, oldLevel, category) {
        const toast = document.createElement("div");
        const catLabel = category ? ` ${category}` : '';
        toast.style.cssText = "position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:#0a0a0a;border:1px solid #00ff66;border-radius:10px;padding:14px 24px;color:#fff;font-size:14px;box-shadow:0 0 20px rgba(0,255,102,0.3);animation:fadeIn .3s ease-out;display:flex;align-items:center;gap:10px;cursor:pointer;max-width:90vw;";
        toast.innerHTML = `<span style="font-size:22px;">üéâ</span><span>Level Up!<strong style="color:#00ff66;">${catLabel}</strong> is now <strong style="color:#ffd84d;">Level ${newLevel}</strong></span>`;
        document.body.appendChild(toast);
        toast.addEventListener("click", () => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); });
        setTimeout(() => { if (toast.parentNode) { toast.style.opacity = '0'; toast.style.transition = 'opacity .3s'; setTimeout(() => toast.remove(), 300); } }, 5000);
    }

    // Toggle Fast Track mode
    function toggleFastTrack(category, enabled) {
        const formData = new FormData();
        formData.append('main_category', category);
        formData.append('enabled', enabled);
        
        fetch('/challenge/fast-track/toggle', {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
            console.log('[FAST-TRACK] Toggle successful:', data);
            // Reload page to reflect new state
            window.location.reload();
        })
        .catch(err => {
            console.error('[FAST-TRACK] Toggle failed:', err);
            alert('Failed to toggle Fast Track. Please try again.');
        });
    }

    // Check URL parameters for level up
    (function() {
        const p = new URLSearchParams(window.location.search);
        if (p.get("level_up") === "true" && p.get("new_level")) {
            showLevelUpToast(p.get("new_level"), p.get("old_level") || "?", p.get("category") || "");
            // Clean URL without reload
            const clean = window.location.pathname;
            window.history.replaceState({}, document.title, clean);
        }
    })();

    // Logout now uses server-rendered confirmation page (/logout)
    // No JavaScript modal needed - works on all browsers including Samsung Internet
</script>

<!-- Logout confirmation is now server-rendered at /logout route -->

</body>
</html>
