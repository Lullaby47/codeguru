<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}CodeGuru{% endblock %}</title>
    <link rel="stylesheet" href="/static/styles.css">

    {# Get base URL for Open Graph - prefer PUBLIC_BASE_URL (Railway public domain) over request.base_url (internal) #}
    {% if public_base_url %}
        {% set og_base_url = public_base_url %}
        {% set og_full_url = public_base_url ~ request.url.path %}
        {% set og_image_url = public_base_url ~ '/static/share.png' %}
    {% else %}
        {% set og_base_url = request.base_url %}
        {% set og_full_url = request.url %}
        {% set og_image_url = request.base_url ~ 'static/share.png' %}
    {% endif %}

    {# Open Graph / Facebook #}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_full_url }}">
    <meta property="og:title" content="CodeGuru â€” Secure Portal">
    <meta property="og:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta property="og:image" content="{{ og_image_url }}">

    {# Twitter #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ og_full_url }}">
    <meta name="twitter:title" content="CodeGuru â€” Secure Portal">
    <meta name="twitter:description" content="Official CodeGuru login and dashboard. Secure access to your account.">
    <meta name="twitter:image" content="{{ og_image_url }}">

    {# Additional SEO #}
    <meta name="description" content="Official CodeGuru login and dashboard. Secure access to your account.">
</head>

<body>

{% set hide_nav = request.url.path in ['/login', '/signup'] %}

{% if not hide_nav %}
<div class="nav">

    <div class="nav-left">
        <!-- User Profile Icon -->
        <div class="user-profile-icon" id="userProfileIcon" title="Your Profile" 
             data-user-level="{% if user %}{{ user.level }}{% else %}1{% endif %}"
             data-username="{% if user %}{{ user.username }}{% else %}Guest{% endif %}"
             data-email="{% if user %}{{ user.email }}{% else %}guest@example.com{% endif %}"
             data-streak="{% if user %}{{ user.streak }}{% else %}0{% endif %}"
             data-verified="{% if user %}{{ 'Yes' if user.is_verified else 'No' }}{% else %}No{% endif %}">
            <div class="profile-level">{% if user %}{{ user.username }}{% else %}Guest{% endif %}</div>
        </div>

        <!-- Dashboard -->
        <a href="/dashboard" title="Dashboard">
            <div class="nav-item dashboard-icon">
                <span>â–®</span><span>â–®</span><span>â–®</span>
            </div>
        </a>
    </div>

    <div class="nav-quote" id="navQuote">
        Small progress is still progress.
    </div>

    <a href="/dashboard">
        <div class="nav-center">CODEGURU</div>
    </a>

    <div class="nav-right">
        <!-- Admin Links -->
        {% if user %}
            {% set is_main_admin = user.id == 1 %}
            {% set is_co_admin = user.role == "coadmin" %}
            {% set is_admin = is_main_admin or is_co_admin %}
            
            {% if is_admin %}
            <!-- Create Challenge (all admins) -->
            <a href="/admin/challenge/new" title="Create Challenge">
                <div class="nav-item" style="color: #00ff66; font-size: 18px;">âž•</div>
            </a>
            
            <!-- Promote User (main admin only) -->
            {% if is_main_admin %}
            <a href="/admin/users" title="Promote User">
                <div class="nav-item" style="color: #ffc800; font-size: 18px;">ðŸ‘¤</div>
            </a>
            {% endif %}
            {% endif %}
        {% endif %}

        <!-- Today's Challenge -->
        <a href="/challenge" title="Today's Challenge">
            <div class="nav-item challenge-icon">âŒ¬âŒ¬</div>
        </a>

        <!-- Journey -->
        <a href="/journey" title="Journey">
            <div class="nav-item journey-icon">
                â”ƒ<span>â”Šâ”Šâ”Š</span>â”ƒ
            </div>
        </a>

        <!-- Logout -->
        <a href="/logout" title="Logout" class="logout-link" id="logoutLink">
            <div class="nav-item logout-icon">
                <span class="logout-symbol"></span>
            </div>
        </a>
    </div>

</div>
{% endif %}
{% if not hide_nav %}
<!-- Row 2: CODEGURU title below nav on mobile -->
<div class="nav-title-mobile">
    <a href="/dashboard">
        <div class="codeguru-title-mobile">CODEGURU</div>
    </a>
</div>
{% endif %}

<div class="page {% if not hide_nav %}with-nav{% endif %}">
    {% block content %}{% endblock %}
</div>

<script>
    const quotes = [
        "Small progress is still progress.",
        "You are not behind. You are building.",
        "Consistency beats motivation.",
        "Every expert was once confused.",
        "This is hard because it matters.",
        "Stay. Learn. Repeat.",
        "The bug is part of the lesson.",
        "One commit closer than yesterday."
    ];

    let qIndex = Math.floor(Math.random() * quotes.length);
    const quoteEl = document.getElementById("navQuote");

    function setQuote() {
        if (quoteEl) quoteEl.textContent = quotes[qIndex];
    }

    function nextQuote() {
        qIndex = (qIndex + 1) % quotes.length;
        setQuote();
    }

    setQuote();
    setInterval(nextQuote, 300000);
    if (quoteEl) quoteEl.addEventListener("click", nextQuote);

    // User Profile Icon Click Handler (desktop)
    const profileIcon = document.getElementById("userProfileIcon");
    if (profileIcon) {
        profileIcon.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // User Profile Icon Click Handler (mobile)
    const profileIconMobile = document.getElementById("userProfileIconMobile");
    if (profileIconMobile) {
        profileIconMobile.addEventListener("click", function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }

    // Show Profile Modal
    function showProfileModal() {
        // Try desktop icon first, fall back to mobile icon
        const profileIcon = document.getElementById("userProfileIcon") || document.getElementById("userProfileIconMobile");
        if (!profileIcon) return;

        const userLevel = profileIcon.getAttribute("data-user-level") || "1";
        const username = profileIcon.getAttribute("data-username") || "Guest";
        const email = profileIcon.getAttribute("data-email") || "guest@example.com";
        const streak = profileIcon.getAttribute("data-streak") || "0";
        const verified = profileIcon.getAttribute("data-verified") || "No";

        const overlay = document.createElement("div");
        overlay.className = "profile-overlay";
        overlay.innerHTML = `
            <div class="profile-modal" onclick="event.stopPropagation()">
                <h2>${username}</h2>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-label">Level</div>
                        <div class="profile-stat-value">${userLevel}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Streak</div>
                        <div class="profile-stat-value">${streak}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Verified</div>
                        <div class="profile-stat-value" style="font-size: 20px; margin-top: 10px;">${verified === 'Yes' ? 'âœ“' : 'âœ—'}</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-label">Status</div>
                        <div class="profile-stat-value" style="font-size: 18px; margin-top: 10px;">Active</div>
                    </div>
                </div>
                <div class="profile-hint">Click anywhere to close</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Dismiss on click anywhere
        overlay.addEventListener("click", function() {
            overlay.style.animation = "fadeOut 0.3s ease";
            setTimeout(() => overlay.remove(), 300);
        });
    }

    // Check for level up from URL parameter or session storage
    function showCongratulations(newLevel, oldLevel) {
        const overlay = document.createElement("div");
        overlay.className = "congrats-overlay";
        overlay.innerHTML = `
            <div class="congrats-modal" onclick="event.stopPropagation()">
                <h1>ðŸŽ‰ Congratulations!</h1>
                <p>You've been promoted!</p>
                <div class="congrats-level">Level ${oldLevel} â†’ ${newLevel}</div>
                <p>Keep up the great work!</p>
                <div class="congrats-hint">Click anywhere to continue</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Dismiss on click anywhere
        overlay.addEventListener("click", function() {
            overlay.style.animation = "fadeOut 0.3s ease";
            setTimeout(() => overlay.remove(), 300);
            // Remove from session storage
            sessionStorage.removeItem("levelUp");
        });
    }

    // Check URL parameters for level up
    const urlParams = new URLSearchParams(window.location.search);
    const levelUp = urlParams.get("level_up") === "true";
    const newLevel = urlParams.get("new_level");
    const oldLevel = urlParams.get("old_level");
    
    if (levelUp && newLevel && oldLevel) {
        showCongratulations(parseInt(newLevel), parseInt(oldLevel));
        // Clean URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }

    // Logout Confirmation Modal
    // Use static modal in HTML, show/hide with class
    (function() {
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLogoutModal);
        } else {
            initLogoutModal();
        }
        
        function initLogoutModal() {
            const logoutLink = document.querySelector(".logout-link");
            const logoutModal = document.getElementById("logoutModal");
            const logoutBtnYes = document.getElementById("logoutBtnYes");
            const logoutBtnNo = document.getElementById("logoutBtnNo");
            
            if (!logoutLink || !logoutModal || !logoutBtnYes || !logoutBtnNo) {
                console.warn('Logout modal elements not found');
                return; // Elements not found, exit gracefully
            }
        
        // Function to show modal - Samsung Internet compatible
        function showLogoutModal() {
            console.log('Showing logout modal');
            // Prevent body scroll first
            const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            document.body.classList.add("modal-open");
            // Store scroll position for restoration (Samsung Internet)
            if (scrollY) {
                document.body.style.top = `-${scrollY}px`;
            }
            
            // Show modal
            logoutModal.classList.add("is-open");
            logoutModal.setAttribute("aria-hidden", "false");
            
            // Force reflow to ensure styles apply (Samsung Internet)
            void logoutModal.offsetWidth;
            
            // Focus the first button for accessibility
            setTimeout(() => {
                try {
                    logoutBtnNo.focus();
                } catch(e) {
                    // Focus might fail on some mobile browsers, ignore
                }
            }, 100);
        }
        
        // Function to hide modal - Samsung Internet compatible
        function hideLogoutModal() {
            console.log('Hiding logout modal');
            logoutModal.classList.remove("is-open");
            logoutModal.setAttribute("aria-hidden", "true");
            
            // Restore body scroll
            const scrollY = document.body.style.top;
            document.body.classList.remove("modal-open");
            document.body.style.top = '';
            
            // Restore scroll position (Samsung Internet)
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY.replace('-', '')) || 0);
            }
        }
        
        // Handle logout link click/touch - Samsung Internet compatible
        function handleLogoutClick(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            showLogoutModal();
            return false;
        }
        
        // Attach event listeners - support both click and touchend for Samsung Internet
        // Use capture phase to ensure we catch the event before navigation
        logoutLink.addEventListener("click", handleLogoutClick, true);
        logoutLink.addEventListener("touchend", function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            handleLogoutClick(e);
            return false;
        }, true);
        
        // Also prevent default on touchstart to avoid navigation
        logoutLink.addEventListener("touchstart", function(e) {
            // Don't prevent default here, just mark that we're handling it
            logoutLink.dataset.touchHandled = "true";
        }, { passive: true });
        
        // Yes button - proceed to logout (Samsung Internet compatible)
        function handleYesClick(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            window.location.href = "/logout";
            return false;
        }
        
        logoutBtnYes.addEventListener("click", handleYesClick, true);
        logoutBtnYes.addEventListener("touchend", function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            window.location.href = "/logout";
            return false;
        }, true);
        
        // No button - close modal (Samsung Internet compatible)
        function handleNoClick(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            hideLogoutModal();
            return false;
        }
        
        logoutBtnNo.addEventListener("click", handleNoClick, true);
        logoutBtnNo.addEventListener("touchend", function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            hideLogoutModal();
            return false;
        }, true);
        
        // Close on overlay click (outside modal) - Samsung Internet compatible
        logoutModal.addEventListener("click", function(e) {
            if (e.target === logoutModal) {
                e.preventDefault();
                e.stopPropagation();
                hideLogoutModal();
            }
        }, true);
        
        logoutModal.addEventListener("touchend", function(e) {
            if (e.target === logoutModal) {
                e.preventDefault();
                e.stopPropagation();
                hideLogoutModal();
            }
        }, true);
        
        // Close on Escape key
        document.addEventListener("keydown", function(e) {
            if (e.key === "Escape" && logoutModal.classList.contains("is-open")) {
                hideLogoutModal();
            }
        });
        }
    })();
</script>

<!-- Logout Confirmation Modal (static, always present but hidden - placed at end of body for z-index stacking) -->
<div id="logoutModal" class="logout-overlay" aria-hidden="true">
    <div class="logout-modal" role="dialog" aria-labelledby="logoutModalTitle" aria-modal="true">
        <h2 id="logoutModalTitle">Log Out</h2>
        <p>Are you sure you want to log out?</p>
        <div class="logout-modal-buttons">
            <button type="button" class="logout-btn-yes" id="logoutBtnYes">Yes</button>
            <button type="button" class="logout-btn-no" id="logoutBtnNo">No</button>
        </div>
    </div>
</div>

</body>
</html>
