{% extends "base.html" %}

{% block content %}

<!-- Category Selector -->
<style>
.category-btn {
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: block;
    width: 100%;
    box-sizing: border-box;
    text-align: left;
}
.category-btn.active {
    background: rgba(0, 255, 102, 0.15);
    color: #00ff66;
    border: 1px solid rgba(0, 255, 102, 0.3);
}
.category-btn.inactive {
    background: rgba(136, 136, 136, 0.15);
    color: #888;
    border: 1px solid rgba(136, 136, 136, 0.3);
}
.category-btn:hover {
    background: rgba(136, 136, 136, 0.25);
    transform: translateY(-2px);
}
.category-btn.active:hover {
    background: rgba(0, 255, 102, 0.25);
}
.category-back-btn {
    display: inline-block;
    margin-bottom: 12px;
    padding: 8px 14px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    color: #00ff66;
    border: 1px solid rgba(0, 255, 102, 0.3);
    background: rgba(0, 255, 102, 0.08);
}
.category-back-btn:hover {
    background: rgba(0, 255, 102, 0.16);
}
.cg-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff66, #00cc55);
    border-radius: 6px;
    transition: width 0.3s;
}

/* Level Panel with Next Level Button Integration */
.level-panel {
    background: #0f0f0f;
    border: 1px solid #1f1f1f;
    border-radius: 10px;
    padding: 14px 16px;
    margin-top: 20px;
    margin-bottom: 20px;
}

.level-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.level-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex: 1;
    min-width: 200px;
}

.level-title {
    color: #00ff66;
    font-weight: 600;
    font-size: 13px;
}

.level-stats {
    font-size: 12px;
    color: #888;
}

.next-level-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #4488ff, #3366cc);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(68, 136, 255, 0.3);
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    border: none;
    cursor: pointer;
}

.next-level-btn:hover {
    background: linear-gradient(135deg, #5599ff, #4477dd);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(68, 136, 255, 0.4);
}

.progress-bar-container {
    background: #1a1a1a;
    border-radius: 6px;
    height: 10px;
    overflow: hidden;
    border: 1px solid #2a2a2a;
    margin-bottom: 8px;
}

.level-bottom-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

/* Mobile Responsive */
@media (max-width: 640px) {
    .level-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .level-info {
        width: 100%;
    }
    
    .next-level-btn {
        width: 100%;
        justify-content: center;
        margin-top: 4px;
    }
}

/* Success Banner Animation */
@keyframes slideInFromTop {
    0% {
        transform: translateY(-20px);
        opacity: 0;
    }
    100% {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>
{% set active_category = selected_category if selected_category else (challenge.main_category if challenge and challenge.main_category else None) %}
{% set show_category_selector = not active_category and not challenge %}
{% if show_category_selector %}
<div style="background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 12px; padding: 20px; margin: 0 auto 20px auto; width: 100%; max-width: 560px;">
    <h3 style="color: #00ff66; font-size: 16px; margin: 0 0 16px 0; font-weight: 600;">üìö Select Category</h3>
    {% if main_categories is defined and main_categories and main_categories|length > 0 %}
    <div style="display: flex; flex-direction: column; gap: 10px;">
        {% for category in main_categories %}
        <a href="/challenge?main_category={{ category|urlencode }}" class="category-btn {% if selected_category == category %}active{% else %}inactive{% endif %}">
            {{ category }}
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div style="color: #888; font-size: 14px; padding: 10px 0;">
        No categories available. Admin needs to create challenges with categories.
    </div>
    {% endif %}
</div>
{% endif %}

{% if not show_category_selector %}
<a href="/challenge" class="category-back-btn">‚Üê Back to Category Selection</a>
<div class="challenge-main-container">
    <div class="challenge-editor-box">
        {% if challenge and challenge.id %}
        <input type="hidden" id="challengeIdData" data-challenge-id="{{ challenge.id }}">
        {% endif %}

        {% if challenge %}

            {% if challenge.main_category or challenge.sub_category %}
            <div style="margin-bottom: 12px; font-size: 12px; color: #888; word-wrap: break-word;">
                {% if challenge.main_category %}
                    <span style="color: #00ff66;">{{ challenge.main_category }}</span>
                {% endif %}
                {% if challenge.main_category and challenge.sub_category %} ‚Ä¢ {% endif %}
                {% if challenge.sub_category %}
                    <span style="color: #ffd84d;">{{ challenge.sub_category }}</span>
                {% endif %}
                {% if challenge.stage_order %}
                    <span style="color: #777;">(Stage {{ challenge.stage_order }})</span>
                {% endif %}
            </div>
            {% endif %}

            {% if challenge.level and challenge.level >= 3 %}
            {% set tips = {
                3: "Tip: You'll use loops and conditions more often now. Think step by step.",
                4: "Tip: Functions help you organize code. Try breaking the problem into smaller parts.",
                5: "Tip: Data structures like lists and dicts are your friends at this level.",
                6: "Tip: Think about edge cases ‚Äî empty inputs, large numbers, special characters.",
                7: "Tip: Efficiency matters more now. Consider how your code scales.",
                8: "Tip: Read the problem twice before writing code. Plan first, code second.",
                9: "Tip: Review your solution for readability. Clean code is correct code.",
                10: "Tip: At this level, debugging skills are as important as coding skills."
            } %}
            {% set tip_text = tips.get(challenge.level, "Tip: Advanced challenges require patience. Break the problem down.") %}
            <div style="background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.15); border-radius: 8px; padding: 10px 14px; margin-bottom: 14px; font-size: 12px; color: #88cc88;">
                üí° {{ tip_text }}
            </div>
            {% endif %}

            <h2 style="word-wrap: break-word;">{{ challenge.title }}</h2>
            <p style="word-wrap: break-word; line-height: 1.6;">{{ challenge.description }}</p>

            {% if challenge.expected_output %}
            <div style="margin-top: 20px;">
                <div class="challenge-expected-output">
                    <div class="challenge-expected-output-inner">
                        <div class="challenge-expected-output-label">Expected Output:</div>
                        <div class="challenge-expected-output-value">{{ challenge.expected_output }}</div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if ui_ctx and ui_ctx.current %}
            {% set cur = ui_ctx.current %}
            <div class="level-panel">
                <div class="level-header">
                    <div class="level-info">
                        <span class="level-title">Level {{ cur.level }}</span>
                        <span class="level-stats">{{ cur.solved }}/{{ cur.required }} to level up</span>
                    </div>
                    {% if challenge_already_solved and is_pool_challenge and not edit_mode %}
                    <a href="/force-learning{% if challenge and challenge.main_category %}?main_category={{ challenge.main_category|urlencode }}{% endif %}" class="next-level-btn">
                        üöÄ Next Level
                    </a>
                    {% endif %}
                </div>
                <!-- Progress bar (F1) -->
                {% set pct = ((cur.solved / cur.required) * 100)|int if cur.required > 0 else 0 %}
                <div class="progress-bar-container">
                    <div class="cg-progress-fill" data-pct="{{ pct }}"></div>
                </div>
                <script>
                (function(){var el=document.querySelector('.cg-progress-fill[data-pct]');if(el)el.style.width=el.getAttribute('data-pct')+'%';})();
                </script>
                <div class="level-bottom-info">
                    <!-- Fast Track badge (F5) -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        {% if cur.fast_track %}
                        <span style="color: #ffd84d;">üöÄ Fast Track ON</span>
                        {% else %}
                        <!-- Daily limit indicator (F6) -->
                        <span style="color: #888;">üìÖ Daily: {{ cur.daily_used }}/{{ cur.daily_cap }} used today</span>
                        {% endif %}
                    </div>
                    {% if cur.remaining > 0 %}
                    <span style="color: #666;">{{ cur.remaining }} more to go</span>
                    {% else %}
                    <span style="color: #00ff66;">Ready to level up!</span>
                    {% endif %}
                </div>
                <!-- Fast Track Toggle Button -->
                {% if selected_category %}
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #2a2a2a;">
                    {% if cur.fast_track %}
                    <button onclick="toggleFastTrack('{{ selected_category }}', false); return false;" style="width: 100%; padding: 8px 12px; font-size: 12px; background: rgba(255, 100, 100, 0.15); color: #ff6666; border: 1px solid rgba(255, 100, 100, 0.4); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 600;">
                        üõë Disable Fast Track (Return to Daily Mode)
                    </button>
                    {% else %}
                    <button onclick="toggleFastTrack('{{ selected_category }}', true); return false;" style="width: 100%; padding: 8px 12px; font-size: 12px; background: rgba(255, 216, 77, 0.15); color: #ffd84d; border: 1px solid rgba(255, 216, 77, 0.4); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 600;">
                        üöÄ Enable Fast Track (Unlimited Challenges)
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% elif progress_info %}
            <div class="alert alert-success" style="margin-top: 20px; margin-bottom: 20px;">
                üìä Level {{ progress_info.level }} Progress: {{ progress_info.solved }}/{{ progress_info.required }} solved
            </div>
            {% endif %}

            {% if request.query_params.get("correct") == "1" %}
            <div class="alert" style="background: rgba(0, 255, 102, 0.15); border: 2px solid rgba(0, 255, 102, 0.6); color: #00ff66; margin-bottom: 20px; animation: slideInFromTop 0.4s ease-out;">
                ‚úÖ <strong>Correct!</strong> Great job! Keep the momentum going with this next challenge.
                {% if request.query_params.get("prev_submission") %}
                <a href="/submission/{{ request.query_params.get('prev_submission') }}/view" style="color: #00ff66; text-decoration: underline; margin-left: 8px;">View previous submission</a>
                {% endif %}
            </div>
            {% endif %}

            {% if success_message is defined and success_message %}
            <div class="alert" style="background: rgba(0, 255, 102, 0.15); border: 2px solid rgba(0, 255, 102, 0.6); color: #00ff66; margin-bottom: 20px;">
                {{ success_message }}
            </div>
            {% endif %}

            {% if challenge_already_solved and is_pool_challenge and edit_mode %}
            <div class="alert" style="background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); color: #ffc800; margin-bottom: 20px;">
                ‚ÑπÔ∏è You've already solved this challenge. You're viewing it in <strong>Improve Mode</strong> to refine your solution.
            </div>
            {% endif %}

            {% if today_completed and not edit_mode %}
                {# DAILY COMPLETE PANEL - User has solved all daily assignments #}
                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                    <h3 style="color: #00ff66; margin-bottom: 10px;">‚úÖ Daily Complete</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                        You've already solved the challenge for today.<br>
                        Come back tomorrow or enable Fast Track to keep going!
                    </p>

                    <div style="background: #1a1400; color: #ffd166; border: 1px solid #332800; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; word-wrap: break-word;">
                        ‚ö° <strong>Learn More</strong> enables permanent Fast Track ‚Äî no daily limit, keep learning!
                    </div>

                    <div class="challenge-actions" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                        <a href="/force-learning{% if selected_category %}?main_category={{ selected_category|urlencode }}{% elif challenge and challenge.main_category %}?main_category={{ challenge.main_category|urlencode }}{% endif %}" class="challenge-btn" style="background: linear-gradient(135deg, #ffd84d, #ffaa00); color: #000; font-weight: 700; box-shadow: 0 4px 12px rgba(255, 216, 77, 0.4);">
                            ‚ö° Learn More (Enable Fast Track)
                        </a>
                        <a href="/challenge" class="challenge-btn secondary" style="background: rgba(136, 136, 136, 0.2); color: #888; border: 1px solid rgba(136, 136, 136, 0.4);">
                            ‚Üê Back to Categories
                        </a>
                    </div>
                </div>

            {% elif flow_state and flow_state.reason == "NO_QUESTIONS_AT_LEVEL" and not edit_mode %}
                {# NO QUESTIONS PANEL - Admin needs to add more #}
                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                    <h3 style="color: #ffd84d; margin-bottom: 10px;">‚è≥ No Questions Available</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                        Wait for Admin/Owner to add more questions at this level.
                    </p>

                    <div class="challenge-actions">
                        <a href="/challenge" class="challenge-btn secondary" style="background: rgba(136, 136, 136, 0.2); color: #888; border: 1px solid rgba(136, 136, 136, 0.4);">
                            ‚Üê Back to Categories
                        </a>
                    </div>
                </div>

            {% elif flow_state and flow_state.reason == "ALL_SOLVED_AT_LEVEL" and not edit_mode %}
                {# ALL SOLVED PANEL - User completed all available at this level #}
                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                    <h3 style="color: #00ff66; margin-bottom: 10px;">üéØ All Questions Solved!</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                        You've solved all available questions at this level.<br>
                        Wait for Admin/Owner to add more or try another category!
                    </p>

                    <div class="challenge-actions">
                        <a href="/challenge" class="challenge-btn secondary" style="background: rgba(136, 136, 136, 0.2); color: #888; border: 1px solid rgba(136, 136, 136, 0.4);">
                            ‚Üê Back to Categories
                        </a>
                    </div>
                </div>

            {% else %}
            <form method="post" action="/challenge/submit-ui" onsubmit="return validateCode();" id="challengeForm">

                <div style="width: 100%; box-sizing: border-box; margin-bottom: 16px;">
                    <textarea
                        id="codeEditor"
                        name="code"
                        placeholder="Improve your Python code here..."
                        oninput="runCode()"
                        class="challenge-editor-textarea"
                    >{{ previous_code or "" }}</textarea>
                </div>

                {% if challenge.id %}
                <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                {% endif %}

                <button id="submitBtn" type="submit" class="challenge-submit-btn">
                    Submit
                </button>
            </form>

            {% if mentor_hint %}
                <div class="alert" id="mentorHint" style="background: rgba(255, 200, 0, 0.15); border: 2px solid rgba(255, 200, 0, 0.6); color: #ffd84d; margin-top: 20px; margin-bottom: 16px; word-wrap: break-word;">
                    üí° <strong>Mentor Hint:</strong> {{ mentor_hint }}
                </div>
                <script>
                    (function() {
                        const hint = document.getElementById('mentorHint');
                        if (hint) {
                            setTimeout(function() {
                                hint.style.opacity = '0';
                                setTimeout(function() {
                                    hint.style.display = 'none';
                                }, 500);
                            }, 8000);
                        }
                    })();
                </script>
            {% endif %}

            {% if error_message is defined and error_message %}
                <div class="alert alert-error" style="margin-top: 20px;">
                    ‚ùå {{ error_message }}
                </div>
                {% if expected_output is defined and expected_output %}
                <div style="margin-top: 12px; background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 8px; padding: 14px;">
                    <div style="font-size: 11px; color: #00ff66; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Expected Output</div>
                    <pre style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; padding: 10px; color: #00ff66; font-size: 12px; white-space: pre-wrap; margin: 0;">{{ expected_output }}</pre>
                    {% if actual_output is defined and actual_output %}
                    <div style="font-size: 11px; color: #ff4444; text-transform: uppercase; margin-top: 10px; margin-bottom: 6px; font-weight: 600;">Your Output</div>
                    <pre style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; padding: 10px; color: #ff8888; font-size: 12px; white-space: pre-wrap; margin: 0;">{{ actual_output }}</pre>
                    {% endif %}
                    <!-- AI Hint / Fallback Tip -->
                    {% if ai_hint is defined and ai_hint %}
                    <div style="margin-top: 10px; border-top: 1px solid #1f1f1f; padding-top: 8px;">
                        {% if ai_hint_is_ai is defined and ai_hint_is_ai %}
                        <span style="font-size: 10px; color: #00ff66; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ü§ñ AI Tip</span>
                        {% else %}
                        <span style="font-size: 10px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üí° Tip</span>
                        {% endif %}
                        <div style="font-size: 12px; color: #ccc; margin-top: 4px; line-height: 1.5;">{{ ai_hint }}</div>
                    </div>
                    {% else %}
                    <div style="margin-top: 10px; font-size: 11px; color: #888; border-top: 1px solid #1f1f1f; padding-top: 8px;">
                        üí° Tip: Check spelling, capitalization, and extra spaces.
                    </div>
                    {% endif %}
                </div>
                {% else %}
                    <!-- No expected output panel ‚Äî show AI hint standalone if available -->
                    {% if ai_hint is defined and ai_hint %}
                    <div style="margin-top: 12px; background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 8px; padding: 14px;">
                        {% if ai_hint_is_ai is defined and ai_hint_is_ai %}
                        <span style="font-size: 10px; color: #00ff66; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ü§ñ AI Tip</span>
                        {% else %}
                        <span style="font-size: 10px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üí° Tip</span>
                        {% endif %}
                        <div style="font-size: 12px; color: #ccc; margin-top: 4px; line-height: 1.5;">{{ ai_hint }}</div>
                    </div>
                    {% endif %}
                {% endif %}
            {% endif %}

            {% if output is defined %}
                <div class="alert {{ 'alert-success' if correct else 'alert-error' }}" style="margin-top: 20px;">
                    {% if correct %}
                        ‚úÖ Correct! Well done.
                    {% else %}
                        ‚ùå Wrong. Try again.
                    {% endif %}

                    <div style="margin-top: 10px; background: #1e1e1e; padding: 10px; color: #0f0; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border-radius: 4px;">{{ output }}</div>
                </div>

                <button onclick="location.reload()" class="challenge-submit-btn" style="margin-top: 12px;">Retry / Improve</button>
            {% endif %}

            {% endif %}

        {% else %}
            {% if selected_category %}
            <div style="text-align: center; padding: 40px 20px; color: #888;">
                {% if no_questions_message %}
                <p style="font-size: 16px; margin-bottom: 10px;">{{ no_questions_message }}</p>
                {% else %}
                <p style="font-size: 16px; margin-bottom: 10px;">No challenges available in "{{ selected_category }}" at your current level.</p>
                {% endif %}
                <p style="font-size: 14px; color: #666;">Wait for Admin/Owner to add more questions, or try another category.</p>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px 20px; color: #888;">
                <p style="font-size: 16px; margin-bottom: 10px;">üëÜ Please select a category above to get started.</p>
                <p style="font-size: 14px; color: #666;">Choose a category to see challenges from that topic.</p>
            </div>
            {% endif %}
        {% endif %}

    </div>

    <!-- Terminal Panel - Stacks below editor on mobile, side-by-side on desktop -->
    <div class="challenge-terminal-panel">
        <div class="challenge-terminal-header">Terminal Output</div>
        <div class="challenge-terminal-output empty" id="terminalOutput">No output yet. Start typing code...</div>
    </div>

</div>
{% endif %}

<!-- Attempts Box - Separate box below main content -->
{% if not show_category_selector and challenge and challenge.id %}
<div class="challenge-attempts-box">
    <div style="padding: 20px 0; border-bottom: 1px solid #3e3e3e; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #00ff66; font-size: 18px;">Previous Attempts</h3>
    </div>
    <div class="challenge-solution-panels" id="solutionPanelsContainer">
        <!-- Panels will be loaded here via JavaScript -->
    </div>
</div>
{% endif %}

<script>
function validateCode() {
    const ta = document.getElementById("codeEditor");
    if (!ta) return true;

    if (!ta.value.trim()) {
        alert("Code cannot be empty.");
        return false;
    }
    return true;
}

// Run code and show output in terminal
let runCodeTimeout;
function runCode() {
    const codeEditor = document.getElementById("codeEditor");
    const terminalOutput = document.getElementById("terminalOutput");
    
    if (!codeEditor || !terminalOutput) return;
    
    // Debounce - wait 500ms after user stops typing
    clearTimeout(runCodeTimeout);
    runCodeTimeout = setTimeout(() => {
        const code = codeEditor.value.trim();
        
        if (!code) {
            terminalOutput.textContent = "No output yet. Start typing code...";
            terminalOutput.classList.add("empty");
            terminalOutput.style.color = "#666";
            return;
        }
        
        terminalOutput.classList.remove("empty");
        terminalOutput.textContent = "Executing code...";
        terminalOutput.style.color = "#ffd84d";
        
        // Execute code via API
        const formData = new URLSearchParams();
        formData.append('code', code);
        
        fetch('/challenge/test-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'include',
            body: formData
        })
        .then(response => {
            if (!response.ok && response.status !== 200) {
                throw new Error(`Server returned ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                // Show error in red, but also show any partial output
                const parts = [];
                if (data.output) parts.push(data.output);
                parts.push(`Error: ${data.error}`);
                terminalOutput.textContent = parts.join("\n");
                terminalOutput.style.color = "#ff4444";
            } else {
                terminalOutput.textContent = data.output || "(No output)";
                terminalOutput.style.color = "#0f0";
            }
        })
        .catch(error => {
            terminalOutput.textContent = `Connection error: ${error.message}`;
            terminalOutput.style.color = "#ff4444";
        });
    }, 500);
}

// Load wrong submissions and display as panels
function loadWrongSubmissions() {
    const container = document.getElementById("solutionPanelsContainer");
    if (!container) return;
    
    const challengeIdElement = document.getElementById("challengeIdData");
    const challengeId = challengeIdElement ? parseInt(challengeIdElement.getAttribute("data-challenge-id")) : null;
    if (!challengeId) return;
    
    fetch(`/submission/wrong/${challengeId}`, {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = '';
        if (data.submissions && data.submissions.length > 0) {
            data.submissions.forEach((submission, index) => {
                const panel = createSolutionPanel(submission, index);
                container.appendChild(panel);
            });
        }
    })
    .catch(error => {
        console.error('Error loading wrong submissions:', error);
    });
}

function createSolutionPanel(submission, index) {
    const panel = document.createElement('div');
    panel.className = 'challenge-solution-panel';
    panel.id = `solutionPanel${index}`;
    
    const challenge = submission.challenge;
    
    panel.innerHTML = `
        <div style="padding: 8px 0; margin-bottom: 10px; border-bottom: 1px solid #1f1f1f; padding-bottom: 8px;">
            <span style="color: #ff4444; font-weight: bold; font-size: 12px;">üí° Attempt #${submission.attempt_number}</span>
        </div>
        <div>
            ${challenge.main_category || challenge.sub_category ? `
            <div style="font-size: 9px; color: #666; margin-bottom: 8px;">
                ${challenge.main_category ? `<span style="color: #00ff66;">${challenge.main_category}</span>` : ''}
                ${challenge.main_category && challenge.sub_category ? ' ‚Ä¢ ' : ''}
                ${challenge.sub_category ? `<span style="color: #ffd84d;">${challenge.sub_category}</span>` : ''}
            </div>
            ` : ''}
            <div style="padding-bottom: 8px; border-bottom: 1px solid #1f1f1f; margin-bottom: 8px;">
                <h3 style="font-size: 14px; margin: 0; color: #fff; line-height: 1.3; word-wrap: break-word;">${challenge.title} - level ${challenge.level}</h3>
            </div>
            <div style="font-size: 9px; color: #666; margin-bottom: 10px;">
                Level ${challenge.level} ‚Ä¢ Attempt #${submission.attempt_number}
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Challenge</h4>
                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #ccc; font-size: 11px; line-height: 1.4; white-space: pre-wrap; max-height: 80px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(challenge.description)}</div>
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Your Solution</h4>
                <pre style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #00ff66; font-family: monospace; font-size: 11px; white-space: pre-wrap; margin: 0; max-height: 100px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(submission.code)}</pre>
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Expected Output</h4>
                <pre style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #00ff66; font-family: monospace; font-size: 11px; white-space: pre-wrap; margin: 0; max-height: 100px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(challenge.expected_output || '')}</pre>
            </div>
        </div>
    `;
    
    return panel;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load wrong submissions when page loads or after form submission
function initChallengePage() {
    loadWrongSubmissions();
    
    // Focus the textarea and run code if it exists
    const ta = document.getElementById("codeEditor");
    if (ta) {
        ta.focus();
        ta.setSelectionRange(0, 0);
        ta.scrollTop = 0;
        
        // Run code if there's existing code
        if (ta.value.trim()) {
            runCode();
        }
    }
    
    // Reload wrong submissions after form submission (for wrong answers)
    const form = document.getElementById("challengeForm");
    if (form) {
        form.addEventListener("submit", function() {
            // Reload wrong submissions after a short delay to allow server to process
            setTimeout(() => {
                loadWrongSubmissions();
            }, 1000);
        });
    }
}

window.addEventListener("load", initChallengePage);
</script>

{% endblock %}
