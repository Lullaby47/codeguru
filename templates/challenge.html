{% extends "base.html" %}

{% block content %}

<!-- Category Selector -->
<style>
.category-btn {
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-block;
}
.category-btn.active {
    background: rgba(0, 255, 102, 0.15);
    color: #00ff66;
    border: 1px solid rgba(0, 255, 102, 0.3);
}
.category-btn.inactive {
    background: rgba(136, 136, 136, 0.15);
    color: #888;
    border: 1px solid rgba(136, 136, 136, 0.3);
}
.category-btn:hover {
    background: rgba(136, 136, 136, 0.25);
    transform: translateY(-2px);
}
.category-btn.active:hover {
    background: rgba(0, 255, 102, 0.25);
}
</style>
<div style="background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
    <h3 style="color: #00ff66; font-size: 16px; margin: 0 0 16px 0; font-weight: 600;">üìö Select Category</h3>
    {% if main_categories is defined and main_categories and main_categories|length > 0 %}
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for category in main_categories %}
        <a href="/challenge?main_category={{ category|urlencode }}" class="category-btn {% if selected_category == category %}active{% else %}inactive{% endif %}">
            {{ category }}
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div style="color: #888; font-size: 14px; padding: 10px 0;">
        No categories available. Admin needs to create challenges with categories.
    </div>
    {% endif %}
</div>

<div class="challenge-main-container">
    <div class="challenge-editor-box">
        {% if challenge and challenge.id %}
        <input type="hidden" id="challengeIdData" data-challenge-id="{{ challenge.id }}">
        {% endif %}

        {% if challenge %}

            {% if challenge.main_category or challenge.sub_category %}
            <div style="margin-bottom: 12px; font-size: 12px; color: #888; word-wrap: break-word;">
                {% if challenge.main_category %}
                    <span style="color: #00ff66;">{{ challenge.main_category }}</span>
                {% endif %}
                {% if challenge.main_category and challenge.sub_category %} ‚Ä¢ {% endif %}
                {% if challenge.sub_category %}
                    <span style="color: #ffd84d;">{{ challenge.sub_category }}</span>
                {% endif %}
                {% if challenge.stage_order %}
                    <span style="color: #777;">(Stage {{ challenge.stage_order }})</span>
                {% endif %}
            </div>
            {% endif %}

            <h2 style="word-wrap: break-word;">{{ challenge.title }}</h2>
            <p style="word-wrap: break-word; line-height: 1.6;">{{ challenge.description }}</p>

            {% if challenge.expected_output %}
            <div style="margin-top: 20px;">
                <div class="challenge-expected-output">
                    <div class="challenge-expected-output-inner">
                        <div class="challenge-expected-output-label">Expected Output:</div>
                        <div class="challenge-expected-output-value">{{ challenge.expected_output }}</div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if progress_info %}
            <div class="alert alert-success" style="margin-top: 20px; margin-bottom: 20px;">
                üìä Level {{ progress_info.level }} Progress: {{ progress_info.solved }}/{{ progress_info.required }} challenges solved
                {% if progress_info.solved < progress_info.required %}
                    <br><small style="color: #888;">Solve {{ progress_info.required - progress_info.solved }} more to level up!</small>
                {% else %}
                    <br><small style="color: #00ff66;">Ready to level up! üöÄ</small>
                {% endif %}
            </div>
            {% endif %}

            {% if challenge_already_solved and is_pool_challenge and not edit_mode %}
            <div class="alert" style="background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); color: #ffc800; margin-bottom: 20px;">
                ‚úÖ You've already solved this challenge! Click <a href="/force-learning" style="color: #ffc800; text-decoration: underline; font-weight: bold;">Learn More</a> to get a different one.
            </div>
            {% endif %}

            {% if today_completed and not edit_mode and not is_pool_challenge %}

                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                    <h3 style="color: #00ff66; margin-bottom: 10px;">‚úÖ Today's challenge completed</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                        You've already submitted today's solution.<br>
                        Consistency beats rushing ‚Äî come back tomorrow üöÄ
                    </p>

                    <div class="challenge-actions">
                        <a href="/journey" class="challenge-btn">üìú Journey</a>
                        <a href="/journey" class="challenge-btn secondary">üîÅ Improve via Journey</a>
                    </div>

                    <div style="background: #1a1400; color: #ffd166; border: 1px solid #332800; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 13px; word-wrap: break-word;">
                        ‚ö†Ô∏è <strong>Learn More</strong> lets you move faster, but deep mastery comes from spaced repetition, not speed.
                    </div>

                    <div class="challenge-actions" style="margin-top: 15px;">
                        <a href="/force-learning" class="challenge-btn secondary" style="color: #ffd84d; text-shadow: 0 0 8px rgba(255, 216, 77, 0.7); box-shadow: 0 0 10px rgba(255, 216, 77, 0.5); border: 1px solid rgba(255, 216, 77, 0.7);">
                            ‚ö° Learn More
                        </a>
                    </div>
                </div>

            {% else %}
            <form method="post" action="/challenge/submit-ui" onsubmit="return validateCode();" id="challengeForm">

                <div style="width: 100%; box-sizing: border-box; margin-bottom: 16px;">
                    <textarea
                        id="codeEditor"
                        name="code"
                        placeholder="Improve your Python code here..."
                        oninput="runCode()"
                        class="challenge-editor-textarea"
                    >{{ previous_code or "" }}</textarea>
                </div>

                {% if challenge.id %}
                <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                {% endif %}

                <button id="submitBtn" type="submit" class="challenge-submit-btn">
                    Submit
                </button>
            </form>

            {% if mentor_hint %}
                <div class="alert" id="mentorHint" style="background: rgba(255, 200, 0, 0.15); border: 2px solid rgba(255, 200, 0, 0.6); color: #ffd84d; margin-top: 20px; margin-bottom: 16px; word-wrap: break-word;">
                    üí° <strong>Mentor Hint:</strong> {{ mentor_hint }}
                </div>
                <script>
                    (function() {
                        const hint = document.getElementById('mentorHint');
                        if (hint) {
                            setTimeout(function() {
                                hint.style.opacity = '0';
                                setTimeout(function() {
                                    hint.style.display = 'none';
                                }, 500);
                            }, 8000);
                        }
                    })();
                </script>
            {% endif %}

            {% if error_message is defined and error_message %}
                <div class="alert alert-error" style="margin-top: 20px;">
                    ‚ùå {{ error_message }}
                </div>
            {% endif %}

            {% if output is defined %}
                <div class="alert {{ 'alert-success' if correct else 'alert-error' }}" style="margin-top: 20px;">
                    {% if correct %}
                        ‚úÖ Correct! Well done.
                    {% else %}
                        ‚ùå Wrong. Try again.
                    {% endif %}

                    <div style="margin-top: 10px; background: #1e1e1e; padding: 10px; color: #0f0; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border-radius: 4px;">{{ output }}</div>
                </div>

                <button onclick="location.reload()" class="challenge-submit-btn" style="margin-top: 12px;">Retry / Improve</button>
            {% endif %}

            {% endif %}

        {% else %}
            {% if selected_category %}
            <div style="text-align: center; padding: 40px 20px; color: #888;">
                <p style="font-size: 16px; margin-bottom: 10px;">No challenges available in "{{ selected_category }}" at your current level.</p>
                <p style="font-size: 14px; color: #666;">Try selecting a different category or level up to unlock more challenges.</p>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px 20px; color: #888;">
                <p style="font-size: 16px; margin-bottom: 10px;">üëÜ Please select a category above to get started.</p>
                <p style="font-size: 14px; color: #666;">Choose a category to see challenges from that topic.</p>
            </div>
            {% endif %}
        {% endif %}

    </div>

    <!-- Terminal Panel - Stacks below editor on mobile, side-by-side on desktop -->
    <div class="challenge-terminal-panel">
        <div class="challenge-terminal-header">Terminal Output</div>
        <div class="challenge-terminal-output empty" id="terminalOutput">No output yet. Start typing code...</div>
    </div>

</div>

<!-- Attempts Box - Separate box below main content -->
{% if challenge and challenge.id %}
<div class="challenge-attempts-box">
    <div style="padding: 20px 0; border-bottom: 1px solid #3e3e3e; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #00ff66; font-size: 18px;">Previous Attempts</h3>
    </div>
    <div class="challenge-solution-panels" id="solutionPanelsContainer">
        <!-- Panels will be loaded here via JavaScript -->
    </div>
</div>
{% endif %}

<script>
function validateCode() {
    const ta = document.getElementById("codeEditor");
    if (!ta) return true;

    if (!ta.value.trim()) {
        alert("Code cannot be empty.");
        return false;
    }
    return true;
}

// Run code and show output in terminal
let runCodeTimeout;
function runCode() {
    const codeEditor = document.getElementById("codeEditor");
    const terminalOutput = document.getElementById("terminalOutput");
    
    if (!codeEditor || !terminalOutput) return;
    
    // Debounce - wait 500ms after user stops typing
    clearTimeout(runCodeTimeout);
    runCodeTimeout = setTimeout(() => {
        const code = codeEditor.value.trim();
        
        if (!code) {
            terminalOutput.textContent = "No output yet. Start typing code...";
            terminalOutput.classList.add("empty");
            terminalOutput.style.color = "#666";
            return;
        }
        
        terminalOutput.classList.remove("empty");
        terminalOutput.textContent = "Executing code...";
        terminalOutput.style.color = "#ffd84d";
        
        // Execute code via API
        const formData = new URLSearchParams();
        formData.append('code', code);
        
        fetch('/challenge/test-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'include',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                terminalOutput.textContent = `Error: ${data.error}`;
                terminalOutput.style.color = "#ff4444";
            } else {
                terminalOutput.textContent = data.output || "(No output)";
                terminalOutput.style.color = "#0f0";
            }
        })
        .catch(error => {
            terminalOutput.textContent = `Error: ${error.message}`;
            terminalOutput.style.color = "#ff4444";
        });
    }, 500);
}

// Load wrong submissions and display as panels
function loadWrongSubmissions() {
    const container = document.getElementById("solutionPanelsContainer");
    if (!container) return;
    
    const challengeIdElement = document.getElementById("challengeIdData");
    const challengeId = challengeIdElement ? parseInt(challengeIdElement.getAttribute("data-challenge-id")) : null;
    if (!challengeId) return;
    
    fetch(`/submission/wrong/${challengeId}`, {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = '';
        if (data.submissions && data.submissions.length > 0) {
            data.submissions.forEach((submission, index) => {
                const panel = createSolutionPanel(submission, index);
                container.appendChild(panel);
            });
        }
    })
    .catch(error => {
        console.error('Error loading wrong submissions:', error);
    });
}

function createSolutionPanel(submission, index) {
    const panel = document.createElement('div');
    panel.className = 'challenge-solution-panel';
    panel.id = `solutionPanel${index}`;
    
    const challenge = submission.challenge;
    
    panel.innerHTML = `
        <div style="padding: 8px 0; margin-bottom: 10px; border-bottom: 1px solid #1f1f1f; padding-bottom: 8px;">
            <span style="color: #ff4444; font-weight: bold; font-size: 12px;">üí° Attempt #${submission.attempt_number}</span>
        </div>
        <div>
            ${challenge.main_category || challenge.sub_category ? `
            <div style="font-size: 9px; color: #666; margin-bottom: 8px;">
                ${challenge.main_category ? `<span style="color: #00ff66;">${challenge.main_category}</span>` : ''}
                ${challenge.main_category && challenge.sub_category ? ' ‚Ä¢ ' : ''}
                ${challenge.sub_category ? `<span style="color: #ffd84d;">${challenge.sub_category}</span>` : ''}
            </div>
            ` : ''}
            <div style="padding-bottom: 8px; border-bottom: 1px solid #1f1f1f; margin-bottom: 8px;">
                <h3 style="font-size: 14px; margin: 0; color: #fff; line-height: 1.3; word-wrap: break-word;">${challenge.title} - level ${challenge.level}</h3>
            </div>
            <div style="font-size: 9px; color: #666; margin-bottom: 10px;">
                Level ${challenge.level} ‚Ä¢ Attempt #${submission.attempt_number}
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Challenge</h4>
                <div style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #ccc; font-size: 11px; line-height: 1.4; white-space: pre-wrap; max-height: 80px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(challenge.description)}</div>
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Your Solution</h4>
                <pre style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #00ff66; font-family: monospace; font-size: 11px; white-space: pre-wrap; margin: 0; max-height: 100px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(submission.code)}</pre>
            </div>
            <div style="margin-top: 12px;">
                <h4 style="font-size: 10px; color: #00ff66; margin-bottom: 6px; text-transform: uppercase;">Expected Output</h4>
                <pre style="background: #1e1e1e; border: 1px solid #3e3e3e; border-radius: 6px; padding: 10px; color: #00ff66; font-family: monospace; font-size: 11px; white-space: pre-wrap; margin: 0; max-height: 100px; overflow-y: auto; word-wrap: break-word;">${escapeHtml(challenge.expected_output || '')}</pre>
            </div>
        </div>
    `;
    
    return panel;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load wrong submissions when page loads or after form submission
function initChallengePage() {
    loadWrongSubmissions();
    
    // Focus the textarea and run code if it exists
    const ta = document.getElementById("codeEditor");
    if (ta) {
        ta.focus();
        ta.setSelectionRange(0, 0);
        ta.scrollTop = 0;
        
        // Run code if there's existing code
        if (ta.value.trim()) {
            runCode();
        }
    }
    
    // Reload wrong submissions after form submission (for wrong answers)
    const form = document.getElementById("challengeForm");
    if (form) {
        form.addEventListener("submit", function() {
            // Reload wrong submissions after a short delay to allow server to process
            setTimeout(() => {
                loadWrongSubmissions();
            }, 1000);
        });
    }
}

window.addEventListener("load", initChallengePage);
</script>

{% endblock %}
