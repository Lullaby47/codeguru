<!-- FILE: templates/progress.html -->
{% extends "journey_layout.html" %}
{% block detail %}

{% set show_celebration = level_up %}

<style>
/* Celebration overlay */
.celebration {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    cursor: pointer;
    animation: fadeIn 0.3s ease-out;
}

.celebration.show {
    display: flex;
}

.celebration-box {
    background: #1a1a1a;
    border: 2px solid #00ff66;
    border-radius: 16px;
    padding: 40px 50px;
    text-align: center;
    box-shadow: 0 0 40px rgba(0, 255, 102, 0.3), 0 0 80px rgba(0, 255, 102, 0.1);
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-width: 400px;
    width: 90%;
}

.celebration-box h1 {
    font-size: 32px;
    margin: 0 0 12px 0;
    color: #fff;
}

.celebration-box p {
    font-size: 16px;
    color: #ccc;
    margin: 0;
    line-height: 1.5;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes popIn {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.progress-container {
    animation: fadeSlide .25s ease-out;
}

.breadcrumb {
    font-size: 11px;
    color: #666;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.breadcrumb .main { color:#00ff66; }
.breadcrumb .sub { color:#ffd84d; }

.title-row {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-bottom: 14px;
    border-bottom: 1px solid #1f1f1f;
}

.title-row h2 {
    font-size: 20px;
    margin: 0;
    word-wrap: break-word;
    line-height: 1.3;
}

.title-row-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.status {
    font-size: 12px;
    padding: 10px 16px;
    border-radius: 12px;
    background: rgba(0, 255, 102, 0.15);
    color: #00ff66;
    border: 1px solid rgba(0, 255, 102, 0.25);
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: opacity 0.2s ease;
    font-weight: bold;
}

.status:hover {
    opacity: 0.8;
}

.progress-btn {
    background: rgba(255, 0, 0, 0.2) !important;
    color: #ff4444 !important;
    border: 1px solid rgba(255, 0, 0, 0.4) !important;
}

.improve-btn {
    background: rgba(68, 136, 255, 0.2) !important;
    color: #4488ff !important;
    border: 1px solid rgba(68, 136, 255, 0.4) !important;
    text-decoration: none;
}

.meta {
    font-size: 11px;
    color: #666;
    margin: 12px 0 18px;
    word-wrap: break-word;
}

.stat {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    font-size: 11px;
    color: #999;
}

.stat strong {
    display: block;
    font-size: 16px;
    color: #fff;
    margin-bottom: 4px;
}

.section {
    margin-top: 22px;
}

.section h3 {
    font-size: 13px;
    color: #00ff66;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.section-content {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 16px;
    color: #ccc;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

pre {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 16px;
    color: #00ff66;
    font-size: 13px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow-x: auto;
}

ul {
    list-style: none;
    padding-left: 0;
    color: #bbb;
}

ul li {
    margin-bottom: 6px;
    word-wrap: break-word;
}

ul li:before {
    content: "‚Üí ";
    color: #00ff66;
}

.attempt-panel {
    background: #2a2a2a;
    border: 1px solid rgba(255, 68, 68, 0.4);
    border-radius: 8px;
    padding: 14px;
    animation: fadeSlide .25s ease-out;
    box-shadow: 0 0 8px rgba(255, 68, 68, 0.2), 0 0 2px rgba(255, 68, 68, 0.3);
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.attempt-panel.correct {
    border: 1px solid rgba(0, 255, 102, 0.4);
    box-shadow: 0 0 8px rgba(0, 255, 102, 0.2), 0 0 2px rgba(0, 255, 102, 0.3);
}

.attempt-header {
    padding: 8px 0;
    margin-bottom: 10px;
    border-bottom: 1px solid #1f1f1f;
    padding-bottom: 8px;
}

.attempt-header span {
    color: #00ff66;
    font-weight: bold;
    font-size: 12px;
}

.attempt-panel:not(.correct) .attempt-header span {
    color: #ff4444;
}

.attempt-title-row {
    padding-bottom: 8px;
    border-bottom: 1px solid #1f1f1f;
    margin-bottom: 8px;
}

.attempt-title-row h3 {
    font-size: 14px;
    margin: 0;
    color: #fff;
    line-height: 1.3;
    word-wrap: break-word;
}

.attempt-meta {
    font-size: 9px;
    color: #666;
    margin-bottom: 10px;
}

.attempt-section {
    margin-top: 12px;
}

.attempt-section h4 {
    font-size: 10px;
    color: #00ff66;
    margin-bottom: 6px;
    text-transform: uppercase;
}

.attempt-code {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 6px;
    padding: 10px;
    color: #00ff66;
    font-family: monospace;
    font-size: 11px;
    white-space: pre-wrap;
    margin: 0;
    max-height: 100px;
    overflow-y: auto;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

@media (min-width: 720px) {
    .title-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
    }

    .title-row h2 {
        font-size: 22px;
    }
}
</style>

{% if show_celebration %}
<div class="celebration show" onclick="this.remove()">
    <div class="celebration-box">
        <h1>üéâ Congratulations!</h1>
        <p>You leveled up from Level {{ old_level }} to Level {{ new_level }}{% if submission.challenge.main_category %} in {{ submission.challenge.main_category }}{% endif %}!</p>
    </div>
</div>
{% elif submission.is_correct %}
<div class="celebration show" onclick="this.remove()">
    <div class="celebration-box">
        <h1>‚úÖ Correct!</h1>
        <p>Well done! Your answer is correct.</p>
    </div>
</div>
{% endif %}

<div class="progress-container">

    <div class="breadcrumb">
        <span class="main">{{ submission.challenge.main_category }}</span>
        ‚Ä¢ <span class="sub">{{ submission.challenge.sub_category }}</span>
    </div>

    <div class="title-row">
        <h2>{{ submission.challenge.title }} - level {{ submission.challenge.level }}</h2>
        <div class="title-row-buttons">
            <span class="status progress-btn" id="progressBtn" onclick="toggleAttempts()">Progress</span>
            <a href="/challenge?challenge_id={{ submission.challenge.id }}&edit=1" class="status improve-btn">Improve</a>
        </div>
    </div>

    <div class="meta">
        Level {{ submission.challenge.level }} ‚Ä¢ {{ submission.created_at }}
    </div>

    <div class="progress-stats">
        <div class="stat"><strong>{{ submission.attempt_number }}</strong>Attempt</div>
        <div class="stat"><strong>{{ 'Yes' if submission.is_correct else 'No' }}</strong>Correct</div>
        <div class="stat"><strong>#{{ submission.id }}</strong>ID</div>
    </div>

    <div class="section">
        <h3>Challenge</h3>
        <div class="section-content">{{ submission.challenge.description }}</div>
    </div>

    <div class="section">
        <h3>Your Solution</h3>
        <pre>{{ submission.code }}</pre>
    </div>

    <div class="section">
        <h3>What you unlocked</h3>
        <ul>
            <li>Breaking problems into steps</li>
            <li>Understanding output</li>
            <li>Why retries matter</li>
        </ul>
    </div>

    <!-- All Attempts Container -->
    <div class="progress-attempts-container" id="attemptsContainer" style="display: none;">
        <!-- Attempts will be loaded here via JavaScript -->
    </div>

</div>

<script>
let attemptsLoaded = false;
let attemptsVisible = false;

function toggleAttempts() {
    const container = document.getElementById("attemptsContainer");
    if (!container) return;
    
    if (!attemptsVisible) {
        if (!attemptsLoaded) {
            loadAllAttempts();
            attemptsLoaded = true;
        }
        container.style.display = "grid";
        attemptsVisible = true;
    } else {
        container.style.display = "none";
        attemptsVisible = false;
    }
}

function loadAllAttempts() {
    const container = document.getElementById("attemptsContainer");
    if (!container) return;
    
    const challengeId = {{ submission.challenge.id|default(0) }};
    if (!challengeId) {
        console.error('Challenge ID is missing');
        return;
    }
    
    fetch(`/submission/all/${challengeId}`, {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = '';
        if (data.submissions && data.submissions.length > 0) {
            data.submissions.forEach((submission) => {
                const panel = createAttemptPanel(submission);
                container.appendChild(panel);
            });
        } else {
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 20px; word-wrap: break-word;">No attempts found</div>';
        }
    })
    .catch(error => {
        console.error('Error loading attempts:', error);
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ff4444; padding: 20px; word-wrap: break-word;">Error loading attempts</div>';
    });
}

function createAttemptPanel(submission) {
    const panel = document.createElement('div');
    panel.className = `attempt-panel ${submission.is_correct ? 'correct' : ''}`;
    
    const challenge = submission.challenge;
    
    panel.innerHTML = `
        <div class="attempt-header">
            <span>${submission.is_correct ? '‚úÖ' : '‚ùå'} Attempt #${submission.attempt_number}</span>
        </div>
        <div class="attempt-title-row">
            <h3>${challenge.title} - level ${challenge.level}</h3>
        </div>
        <div class="attempt-meta">
            Level ${challenge.level} ‚Ä¢ Attempt #${submission.attempt_number} ‚Ä¢ ${submission.is_correct ? 'Correct' : 'Wrong'}
        </div>
        <div class="attempt-section">
            <h4>Your Solution</h4>
            <pre class="attempt-code">${escapeHtml(submission.code)}</pre>
        </div>
    `;
    
    return panel;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}
