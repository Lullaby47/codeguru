<!-- FILE: templates/progress.html -->
{% extends "journey_layout.html" %}
{% block detail %}

{% set show_celebration = submission.new_level is defined %}

<style>
.progress-container {
    animation: fadeSlide .25s ease-out;
}

@keyframes fadeSlide {
    from { opacity:0; transform:translateY(6px); }
    to { opacity:1; transform:none; }
}

.breadcrumb {
    font-size: 11px;
    color: #666;
    margin-bottom: 10px;
}

.breadcrumb .main { color:#00ff66; }
.breadcrumb .sub { color:#ffd84d; }

.title-row {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    padding-bottom:14px;
    border-bottom:1px solid #1f1f1f;
}

.title-row h2 {
    font-size:22px;
    margin:0;
}

.status {
    font-size:10px;
    padding:5px 12px;
    border-radius:12px;
    background:rgba(0,255,102,.15);
    color:#00ff66;
    border:1px solid rgba(0,255,102,.25);
}

.progress-btn {
    background:rgba(255,0,0,.2) !important;
    color:#ff4444 !important;
    border:1px solid rgba(255,0,0,.4) !important;
    font-weight:bold;
}

.meta {
    font-size:11px;
    color:#666;
    margin:12px 0 18px;
}

.stats {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-bottom:22px;
}

.stat {
    background:#2a2a2a;
    border:1px solid #3a3a3a;
    border-radius:8px;
    padding:12px;
    text-align:center;
    font-size:11px;
    color:#999;
}

.stat strong {
    display:block;
    font-size:16px;
    color:#fff;
}

.section {
    margin-top:22px;
}

.section h3 {
    font-size:13px;
    color:#00ff66;
    margin-bottom:10px;
    text-transform:uppercase;
}

pre {
    background:#2a2a2a;
    border:1px solid #3a3a3a;
    border-radius:8px;
    padding:16px;
    color:#00ff66;
    font-size:13px;
}

ul {
    list-style:none;
    padding-left:0;
    color:#bbb;
}

ul li {
    margin-bottom:6px;
}

ul li:before {
    content:"‚Üí ";
    color:#00ff66;
}

/* Attempt Panels Container */
.attempts-container {
    margin-top: 22px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.attempt-panel {
    background: #2a2a2a;
    border: 1px solid rgba(255, 68, 68, 0.4);
    border-radius: 8px;
    padding: 14px;
    animation: fadeSlide .25s ease-out;
    box-shadow: 0 0 8px rgba(255, 68, 68, 0.2), 0 0 2px rgba(255, 68, 68, 0.3);
}

.attempt-panel.correct {
    border: 1px solid rgba(0, 255, 102, 0.4);
    box-shadow: 0 0 8px rgba(0, 255, 102, 0.2), 0 0 2px rgba(0, 255, 102, 0.3);
}

.attempt-header {
    padding: 8px 0;
    margin-bottom: 10px;
    border-bottom: 1px solid #1f1f1f;
    padding-bottom: 8px;
}

.attempt-header span {
    color: #00ff66;
    font-weight: bold;
    font-size: 12px;
}

.attempt-panel:not(.correct) .attempt-header span {
    color: #ff4444;
}

.attempt-title-row {
    padding-bottom: 8px;
    border-bottom: 1px solid #1f1f1f;
    margin-bottom: 8px;
}

.attempt-title-row h3 {
    font-size: 14px;
    margin: 0;
    color: #fff;
    line-height: 1.3;
}

.attempt-meta {
    font-size: 9px;
    color: #666;
    margin-bottom: 10px;
}

.attempt-section {
    margin-top: 12px;
}

.attempt-section h4 {
    font-size: 10px;
    color: #00ff66;
    margin-bottom: 6px;
    text-transform: uppercase;
}

.attempt-code {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 10px;
    color: #00ff66;
    font-family: monospace;
    font-size: 11px;
    white-space: pre-wrap;
    margin: 0;
    max-height: 100px;
    overflow-y: auto;
}

.progress-btn {
    cursor: pointer;
    transition: opacity 0.2s ease;
}

.progress-btn:hover {
    opacity: 0.8;
}

.improve-btn {
    background: rgba(68, 136, 255, 0.2) !important;
    color: #4488ff !important;
    border: 1px solid rgba(68, 136, 255, 0.4) !important;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.2s ease;
    margin-left: 8px;
}

.improve-btn:hover {
    opacity: 0.8;
}

.button-group {
    display: flex;
    align-items: center;
    gap: 8px;
}
</style>

{% if show_celebration %}
<div class="celebration show" onclick="this.remove()">
    <div class="celebration-box">
        <h1>üéâ Well Done</h1>
        <p>You unlocked Level {{ submission.new_level }}</p>
    </div>
</div>
{% endif %}

<div class="progress-container">

    <div class="breadcrumb">
        <span class="main">{{ submission.challenge.main_category }}</span>
        ‚Ä¢ <span class="sub">{{ submission.challenge.sub_category }}</span>
    </div>

    <div class="title-row">
        <h2>{{ submission.challenge.title }} - level {{ submission.challenge.level }}</h2>
        <div class="button-group">
            <span class="status progress-btn" id="progressBtn" onclick="toggleAttempts()">Progress</span>
            <a href="/challenge?challenge_id={{ submission.challenge.id }}&edit=1" class="status improve-btn">Improve</a>
        </div>
    </div>

    <div class="meta">
        Level {{ submission.challenge.level }} ‚Ä¢ {{ submission.created_at }}
    </div>

    <div class="stats">
        <div class="stat"><strong>{{ submission.attempt_number }}</strong>Attempt</div>
        <div class="stat"><strong>{{ 'Yes' if submission.is_correct else 'No' }}</strong>Correct</div>
        <div class="stat"><strong>#{{ submission.id }}</strong>ID</div>
    </div>

    <div class="section">
        <h3>Challenge</h3>
        <div style="
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 16px;
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        ">{{ submission.challenge.description }}</div>
    </div>

    <div class="section">
        <h3>Your Solution</h3>
        <pre>{{ submission.code }}</pre>
    </div>

    <div class="section">
        <h3>What you unlocked</h3>
        <ul>
            <li>Breaking problems into steps</li>
            <li>Understanding output</li>
            <li>Why retries matter</li>
        </ul>
    </div>

    <!-- All Attempts Container -->
    <div class="attempts-container" id="attemptsContainer" style="display: none;">
        <!-- Attempts will be loaded here via JavaScript -->
    </div>

</div>

<script>
let attemptsLoaded = false;
let attemptsVisible = false;

function toggleAttempts() {
    const container = document.getElementById("attemptsContainer");
    if (!container) return;
    
    if (!attemptsVisible) {
        if (!attemptsLoaded) {
            loadAllAttempts();
            attemptsLoaded = true;
        }
        container.style.display = "grid";
        attemptsVisible = true;
    } else {
        container.style.display = "none";
        attemptsVisible = false;
    }
}

function loadAllAttempts() {
    const container = document.getElementById("attemptsContainer");
    if (!container) return;
    
    const challengeId = {{ submission.challenge.id|default(0) }};
    if (!challengeId) {
        console.error('Challenge ID is missing');
        return;
    }
    
    fetch(`/submission/all/${challengeId}`, {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        container.innerHTML = '';
        if (data.submissions && data.submissions.length > 0) {
            data.submissions.forEach((submission) => {
                const panel = createAttemptPanel(submission);
                container.appendChild(panel);
            });
        } else {
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 20px;">No attempts found</div>';
        }
    })
    .catch(error => {
        console.error('Error loading attempts:', error);
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ff4444; padding: 20px;">Error loading attempts</div>';
    });
}

function createAttemptPanel(submission) {
    const panel = document.createElement('div');
    panel.className = `attempt-panel ${submission.is_correct ? 'correct' : ''}`;
    
    const challenge = submission.challenge;
    
    panel.innerHTML = `
        <div class="attempt-header">
            <span>${submission.is_correct ? '‚úÖ' : '‚ùå'} Attempt #${submission.attempt_number}</span>
        </div>
        <div class="attempt-title-row">
            <h3>${challenge.title} - level ${challenge.level}</h3>
        </div>
        <div class="attempt-meta">
            Level ${challenge.level} ‚Ä¢ Attempt #${submission.attempt_number} ‚Ä¢ ${submission.is_correct ? 'Correct' : 'Wrong'}
        </div>
        <div class="attempt-section">
            <h4>Your Solution</h4>
            <pre class="attempt-code">${escapeHtml(submission.code)}</pre>
        </div>
    `;
    
    return panel;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{% endblock %}
